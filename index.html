<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mini Social Media</title>
<style>
body { background-color: #f7f7f7; font-family: Arial, sans-serif; padding: 20px; margin:0; }
h1 { color: #333; }
p { font-size: 16px; margin: 5px 0; }

input[type="text"] { padding: 8px; border-radius: 5px; border: 1px solid #ccc; margin-bottom:5px; }
#usernameInput { width: 30%; margin-right: 5px; }
#postInput { width: 50%; margin-right: 5px; }

#avatarDropArea, #imageDropArea {
  display:inline-block; padding:8px; border:2px dashed #ccc; border-radius:5px; cursor:pointer; color:#555;
}
.hover { background-color: #e0e0e0; }

button { padding:8px 12px; border:none; border-radius:5px; background-color:#1877f2; color:white; cursor:pointer; }
button:hover { background-color:#145dbf; }

#feed { max-width:500px; margin:0 auto; padding-top:10px; max-height:70vh; overflow-y:auto; }

.post { background-color:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:15px; margin-bottom:15px; border-radius:10px; }
.post img { display:block; margin-top:10px; width:100%; max-height:400px; object-fit:cover; border-radius:10px; }

.post-header { display:flex; align-items:center; margin-bottom:10px; }
.avatar { width:40px; height:40px; border-radius:50%; margin-right:10px; object-fit:cover; border:1px solid #ccc; }
.username { font-weight:bold; }

.timestamp { font-size:12px; color:#555; margin-top:5px; }

.comment-section { margin-top:10px; }
.comment { background-color:#f0f2f5; padding:5px; border-radius:5px; margin-top:5px; position:relative; }
.reply-section { margin-left:20px; margin-top:5px; }
.comment-input { width:80%; padding:5px; margin-top:10px; border-radius:5px; border:1px solid #ccc; }
.comment-button { padding:5px 10px; margin-left:5px; border-radius:5px; border:none; background-color:#1877f2; color:white; cursor:pointer; }
.comment-button:hover { background-color:#145dbf; }

.edit-btn, .delete-btn, .delete-post-btn { font-size:10px; padding:2px 5px; margin-left:5px; border-radius:3px; cursor:pointer; color:white; }
.edit-btn { background-color:#ffa500; }
.edit-btn:hover { background-color:#e59400; }
.delete-btn { background-color:#ff4d4f; }
.delete-btn:hover { background-color:#d9363e; }
.delete-post-btn { background-color:#ff4d4f; }
.delete-post-btn:hover { background-color:#d9363e; }
</style>
</head>
<body>

<h1>Mini Social Media</h1>
<p>Your username and avatar will persist. You can post images and delete posts!</p>

<input type="text" id="usernameInput" placeholder="Your username">
<div id="avatarDropArea">Click or Drag & Drop Avatar Here</div>
<input type="file" id="avatarInput" accept="image/*" style="display:none;"><br>

<input type="text" id="postInput" placeholder="What's on your mind?">
<div id="imageDropArea">Click or Drag & Drop Post Image Here</div>
<input type="file" id="imageInput" accept="image/*" style="display:none;">
<button onclick="addPost()">Post</button>

<hr>
<div id="feed"></div>

<script>
let draggedPostFile = null;
let currentAvatar = localStorage.getItem('avatar') || null;
let currentUsername = localStorage.getItem('username') || "";

// Load saved username
const usernameInput = document.getElementById("usernameInput");
usernameInput.value = currentUsername;

// Save username on change
usernameInput.addEventListener("input", () => {
  currentUsername = usernameInput.value.trim();
  localStorage.setItem("username", currentUsername);
});

// Avatar upload
const avatarDropArea = document.getElementById("avatarDropArea");
const avatarInputFile = document.getElementById("avatarInput");

avatarDropArea.addEventListener("click", () => avatarInputFile.click());
avatarInputFile.addEventListener("change", e => handleAvatarUpload(e.target.files[0]));
avatarDropArea.addEventListener("dragover", e=>{ e.preventDefault(); avatarDropArea.classList.add("hover"); });
avatarDropArea.addEventListener("dragleave", e=>{ e.preventDefault(); avatarDropArea.classList.remove("hover"); });
avatarDropArea.addEventListener("drop", e=>{ e.preventDefault(); avatarDropArea.classList.remove("hover"); handleAvatarUpload(e.dataTransfer.files[0]); });

function handleAvatarUpload(file){
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    if(e.target && e.target.result) {
        currentAvatar = e.target.result;
        localStorage.setItem('avatar', currentAvatar);
        alert("Avatar saved!");
    }
  };
  reader.readAsDataURL(file);
}

// Post image
const postDropArea = document.getElementById("imageDropArea");
const postInputFile = document.getElementById("imageInput");

postDropArea.addEventListener("click", ()=>postInputFile.click());
postInputFile.addEventListener("change", e=>draggedPostFile=e.target.files[0]);
postDropArea.addEventListener("dragover", e=>{ e.preventDefault(); postDropArea.classList.add("hover"); });
postDropArea.addEventListener("dragleave", e=>{ e.preventDefault(); postDropArea.classList.remove("hover"); });
postDropArea.addEventListener("drop", e=>{ e.preventDefault(); postDropArea.classList.remove("hover"); if(e.dataTransfer.files.length>0) draggedPostFile=e.dataTransfer.files[0]; });

// Load posts from localStorage
function loadPosts(){
  const posts = JSON.parse(localStorage.getItem("posts")||"[]");
  document.getElementById("feed").innerHTML="";
  posts.forEach(post => createPostElement(post));
}

// Create post element
function createPostElement(post){
  const feed = document.getElementById("feed");
  const postDiv = document.createElement("div"); postDiv.className="post";

  // Header
  const headerDiv = document.createElement("div"); headerDiv.className="post-header";
  const avatarImg = document.createElement("img"); avatarImg.className="avatar"; avatarImg.src=post.avatar||"https://via.placeholder.com/40";
  const usernameSpan = document.createElement("span"); usernameSpan.className="username"; usernameSpan.innerText=post.username||"Anonymous";
  headerDiv.appendChild(avatarImg); headerDiv.appendChild(usernameSpan); postDiv.appendChild(headerDiv);

  // Text
  if(post.text){ const textP=document.createElement("p"); textP.innerText=post.text; postDiv.appendChild(textP); }

  // Image
  if(post.image){ const img=document.createElement("img"); img.src=post.image; postDiv.appendChild(img); }

  const timestamp=document.createElement("p"); timestamp.className="timestamp"; timestamp.innerText=post.timestamp; postDiv.appendChild(timestamp);

  // Like button
  const likeButton=document.createElement("button"); let likeCount=post.likes||0;
  likeButton.innerText=`Like (${likeCount})`;
  likeButton.onclick=()=>{ likeCount++; likeButton.innerText=`Like (${likeCount})`; post.likes=likeCount; updatePostInLocalStorage(post); };
  postDiv.appendChild(likeButton);

  // Delete post button
  const deletePostBtn = document.createElement("button");
  deletePostBtn.innerText = "Delete Post";
  deletePostBtn.className="delete-post-btn";
  deletePostBtn.onclick = () => {
      if(confirm("Are you sure you want to delete this post?")){
          postDiv.remove();
          let posts = JSON.parse(localStorage.getItem("posts")||"[]");
          posts = posts.filter(p=>p.timestamp!==post.timestamp);
          localStorage.setItem("posts", JSON.stringify(posts));
      }
  };
  postDiv.appendChild(deletePostBtn);

  // Comments
  const commentInput=document.createElement("input"); commentInput.type="text"; commentInput.placeholder="Write a comment..."; commentInput.className="comment-input";
  const commentButton=document.createElement("button"); commentButton.innerText="Comment"; commentButton.className="comment-button";
  const commentSection=document.createElement("div"); commentSection.className="comment-section";

  post.comments=post.comments||[];
  post.comments.forEach(c=>renderComment(c, commentSection, post));

  commentButton.onclick=()=>{
    const text=commentInput.value.trim(); if(!text) return;
    const commentObj={ text, username:currentUsername||"Anonymous", avatar:currentAvatar, replies:[] };
    post.comments.push(commentObj); renderComment(commentObj, commentSection, post);
    updatePostInLocalStorage(post); commentInput.value="";
  };

  postDiv.appendChild(commentInput); postDiv.appendChild(commentButton); postDiv.appendChild(commentSection);
  feed.prepend(postDiv);
}

// Render comment
function renderComment(commentObj, parentDiv, post){
  const commentDiv=document.createElement("div"); commentDiv.className="comment";

  const header=document.createElement("div"); header.style.display="flex"; header.style.alignItems="center";
  const avatar=document.createElement("img"); avatar.src=commentObj.avatar||"https://via.placeholder.com/30"; avatar.style.width="30px"; avatar.style.height="30px"; avatar.style.borderRadius="50%"; avatar.style.marginRight="5px";
  const username=document.createElement("span"); username.style.fontWeight="bold"; username.innerText=commentObj.username||"Anonymous";
  header.appendChild(avatar); header.appendChild(username); commentDiv.appendChild(header);

  const textP=document.createElement("p"); textP.innerText=commentObj.text; commentDiv.appendChild(textP);

  const replyInput=document.createElement("input"); replyInput.type="text"; replyInput.placeholder="Reply..."; replyInput.className="comment-input";
  const replyButton=document.createElement("button"); replyButton.innerText="Reply"; replyButton.className="comment-button";
  const replySection=document.createElement("div"); replySection.className="reply-section";

  replyButton.onclick=()=>{
    const replyText=replyInput.value.trim(); if(!replyText) return;
    const replyObj={ text:replyText, username:currentUsername||"Anonymous", avatar:currentAvatar, replies:[] };
    commentObj.replies.push(replyObj); renderComment(replyObj, replySection, post); updatePostInLocalStorage(post); replyInput.value="";
  };

  // Edit button
  const editBtn=document.createElement("button"); editBtn.innerText="Edit"; editBtn.className="edit-btn";
  editBtn.onclick=()=>{
    const newText=prompt("Edit your comment:", commentObj.text);
    if(newText!==null){ commentObj.text=newText; textP.innerText=newText; updatePostInLocalStorage(post); }
  };

  // Delete button
  const deleteBtn=document.createElement("button"); deleteBtn.innerText="Delete"; deleteBtn.className="delete-btn";
  deleteBtn.onclick=()=>{
    if(confirm("Delete this comment?")){
      removeCommentFromPost(post, commentObj);
      commentDiv.remove(); updatePostInLocalStorage(post);
    }
  };

  commentDiv.appendChild(editBtn); commentDiv.appendChild(deleteBtn);
  commentDiv.appendChild(replyInput); commentDiv.appendChild(replyButton); commentDiv.appendChild(replySection);
  parentDiv.appendChild(commentDiv);

  if(commentObj.replies) commentObj.replies.forEach(r=>renderComment(r, replySection, post));
}

// Remove comment from post recursively
function removeCommentFromPost(post, targetComment){
  function removeRecursively(arr){
    const index=arr.indexOf(targetComment);
    if(index!==-1){ arr.splice(index,1); return true; }
    for(const c of arr) if(c.replies && removeRecursively(c.replies)) return true;
    return false;
  }
  removeRecursively(post.comments);
}

// Update post in localStorage
function updatePostInLocalStorage(updatedPost){
  let posts=JSON.parse(localStorage.getItem("posts")||"[]");
  posts=posts.map(p=>p.timestamp===updatedPost.timestamp?updatedPost:p);
  localStorage.setItem("posts", JSON.stringify(posts));
}

// Add post
function addPost(){
  const postText=document.getElementById("postInput").value.trim();
  currentUsername=usernameInput.value.trim()||currentUsername||"Anonymous";
  localStorage.setItem("username", currentUsername);

  if(!postText && !draggedPostFile){ alert("Type something or add an image!"); return; }

  const post={ text: postText, username:currentUsername, avatar:currentAvatar, image:null, timestamp:new Date().toLocaleString(), likes:0, comments:[] };

  const savePost=()=>{
    createPostElement(post);
    let posts=JSON.parse(localStorage.getItem("posts")||"[]");
    posts.unshift(post);
    localStorage.setItem("posts", JSON.stringify(posts));
    draggedPostFile = null;
  };

  if(draggedPostFile){
    const reader=new FileReader();
    reader.onload=e=>{ if(e.target && e.target.result){ post.image=e.target.result; savePost(); } };
    reader.readAsDataURL(draggedPostFile);
  } else savePost();

  document.getElementById("postInput").value="";
}

window.onload=loadPosts;
</script>
</body>
</html>
